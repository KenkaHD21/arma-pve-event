<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Organigramm – PVE Event | Arma Reforger</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Rajdhani:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-dark: #0d1117;
            --bg-card: #161b22;
            --accent: #238636;
            --accent-dim: #2ea043;
            --text: #e6edf3;
            --text-muted: #8b949e;
            --border: #30363d;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Rajdhani', sans-serif; background: var(--bg-dark); color: var(--text); min-height: 100vh; }
        .container { max-width: 1100px; margin: 0 auto; padding: 2rem; }
        header { text-align: center; padding: 1rem 0; border-bottom: 2px solid var(--accent); }
        h1 { font-family: 'Share Tech Mono', monospace; font-size: 1.5rem; color: var(--accent); }
        nav { display: flex; gap: 1rem; justify-content: center; margin: 1rem 0; flex-wrap: wrap; }
        nav a { color: var(--accent); text-decoration: none; padding: 0.5rem 1rem; border: 1px solid var(--border); border-radius: 4px; }
        nav a:hover { background: var(--accent); color: var(--bg-dark); }
        .org-wrapper { background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; padding: 2rem; margin: 2rem 0; }
        .org-chart { display: flex; flex-direction: column; align-items: center; gap: 0; }
        .org-row { display: flex; justify-content: center; align-items: flex-start; gap: 1.5rem; margin: 0.5rem 0; flex-wrap: wrap; }
        .squad-group { display: flex; flex-direction: column; align-items: center; gap: 0.5rem; flex-shrink: 0; }
        .org-node {
            background: var(--bg-dark);
            border: 2px solid var(--accent);
            border-radius: 6px;
            padding: 0.5rem 0.75rem;
            text-align: center;
            min-width: 140px;
        }
        .org-node.platoon { border-color: var(--accent); background: rgba(35, 134, 54, 0.15); }
        .org-node.squad { border-color: var(--accent-dim); }
        .org-node.fireteam { border-color: var(--border); }
        .org-node input {
            background: transparent; border: none; color: inherit; width: 100%; font: inherit; text-align: center;
            font-weight: 700; color: var(--accent); font-size: 0.95rem;
        }
        .org-node .slot, .org-node .slot-input { font-size: 0.8rem; color: var(--text-muted); margin-top: 0.2rem; }
        .org-node .slot-input { background: transparent; border: none; color: var(--text-muted); width: 100%; font-size: 0.8rem; text-align: center; }
        .org-node .slot-name { font-size: 0.85rem; color: var(--accent-dim); margin-top: 0.25rem; }
        .connector { width: 2px; height: 24px; background: var(--border); margin: 0 auto; }
        .connector-h { width: 60px; height: 2px; background: var(--border); }
        .connector-row { display: flex; align-items: center; justify-content: center; gap: 0; }
        .connector-row .connector-h { flex: 1; max-width: 80px; }
        .ft-row { display: flex; gap: 1rem; justify-content: center; }
        .btn-row { margin-bottom: 1rem; }
        .btn { padding: 0.5rem 1rem; background: var(--accent); border: none; border-radius: 4px; color: var(--bg-dark); font-weight: 600; cursor: pointer; font-size: 0.9rem; }
        .btn-outline { background: transparent; color: var(--accent); border: 1px solid var(--accent); }
        .btn-rm { padding: 0.2rem 0.5rem; font-size: 0.75rem; margin-top: 0.25rem; }
        .legend { display: flex; gap: 2rem; justify-content: center; margin-top: 2rem; flex-wrap: wrap; }
        .legend-item { display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem; }
        .legend-dot { width: 12px; height: 12px; border-radius: 2px; }
        .legend-dot.platoon { background: var(--accent); }
        .legend-dot.squad { background: var(--accent-dim); }
        .legend-dot.ft { background: var(--border); }
    </style>
</head>
<body>
    <div class="container">
        <header><h1>ORGANIGRAMM – BEFEHLSSTRUKTUR</h1></header>
        <nav>
            <a href="index.html">Übersicht</a>
            <a href="organigramm.html">Organigramm</a>
            <a href="funk.html">Funkplan</a>
            <a href="slotliste.html">Slotliste</a>
            <a href="mods.html">Mods</a>
            <a href="ladef.html">LADEF</a>
            <a href="checkliste.html">Checkliste</a>
        </nav>

        <div class="btn-row">
            <button type="button" class="btn btn-outline" id="btn-add-squad">+ Squad hinzufügen</button>
        </div>

        <div class="org-wrapper">
            <div class="org-chart" id="org-chart"></div>
            <div class="legend">
                <div class="legend-item"><span class="legend-dot platoon"></span> Platoon (Zug)</div>
                <div class="legend-item"><span class="legend-dot squad"></span> Squad (Gruppe)</div>
                <div class="legend-item"><span class="legend-dot ft"></span> Fire Team</div>
            </div>
        </div>

        <section style="background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; padding: 1.5rem; margin-top: 1rem;">
            <h2 style="color: var(--accent); font-size: 1.1rem; margin-bottom: 0.75rem;">Befehlsweg</h2>
            <p>PL → SL → FTL → Mannschaft. Meldungen laufen von unten nach oben, Befehle von oben nach unten. Bei Abwesenheit des PL übernimmt der dienstälteste SL.</p>
        </section>
    </div>

    <script src="csv-export.js"></script>
    <script>
        const SLOT_BY_SQUAD = { 0: 5, 1: 13, 2: 21, 3: 29 };

        function getOrganigrammData() {
            const platoonTitle = document.getElementById('org-platoon-title');
            const platoonSub = document.getElementById('org-platoon-subtitle');
            const squads = [];
            document.querySelectorAll('.squad-group').forEach((grp, idx) => {
                const titleEl = grp.querySelector('.squad-title');
                const subEl = grp.querySelector('.squad-subtitle');
                const faTitle = grp.querySelector('.ft-alpha-title');
                const faSub = grp.querySelector('.ft-alpha-sub');
                const fbTitle = grp.querySelector('.ft-bravo-title');
                const fbSub = grp.querySelector('.ft-bravo-sub');
                squads.push({
                    title: titleEl ? titleEl.value : '',
                    subtitle: subEl ? subEl.value : '',
                    ftAlpha: { title: faTitle ? faTitle.value : '', subtitle: faSub ? faSub.value : '' },
                    ftBravo: { title: fbTitle ? fbTitle.value : '', subtitle: fbSub ? fbSub.value : '' }
                });
            });
            return {
                platoon: { title: platoonTitle ? platoonTitle.value : '', subtitle: platoonSub ? platoonSub.value : '' },
                squads
            };
        }

        function saveOrg() {
            updateCsvStorage({ organigramm: getOrganigrammData() });
        }

        function saveSlotNames() {
            const data = loadFromCsvStorage();
            const slotliste = data.slotliste || {};
            const chart = document.getElementById('org-chart');
            if (!chart) return;
            chart.querySelectorAll('.slot-name[data-slot]').forEach(inp => {
                const slot = inp.dataset.slot;
                const name = inp.value.trim();
                if (slot) {
                    slotliste[slot] = slotliste[slot] || {};
                    slotliste[slot].name = name;
                }
            });
            updateCsvStorage({ slotliste });
        }

        function render() {
            const data = loadFromCsvStorage();
            const org = data.organigramm && data.organigramm.squads && data.organigramm.squads.length
                ? data.organigramm
                : DEFAULT_ORGANIGRAMM;
            const slotliste = data.slotliste || {};
            const platoon = org.platoon || DEFAULT_ORGANIGRAMM.platoon;
            const squads = org.squads || DEFAULT_ORGANIGRAMM.squads;

            const chart = document.getElementById('org-chart');
            const esc = s => (s || '').replace(/</g, '&lt;').replace(/"/g, '&quot;');

            let html = '';
            html += '<div class="org-node platoon">';
            html += '<input type="text" id="org-platoon-title" value="' + esc(platoon.title) + '" placeholder="z.B. PLATOON LEAD (PL)" maxlength="60">';
            html += '<input type="text" class="slot-input" id="org-platoon-subtitle" value="' + esc(platoon.subtitle) + '" placeholder="z.B. Zugführer" maxlength="40">';
            html += '<input type="text" class="slot-input slot-name" data-slot="1" data-field="name" value="' + esc((slotliste['1'] || slotliste[1] || {}).name || '') + '" placeholder="Name (PL)" maxlength="40">';
            html += '</div>';

            html += '<div class="connector"></div>';
            html += '<div class="connector-row">';
            for (let i = 0; i < Math.max(squads.length, 1); i++) html += '<div class="connector-h"></div>';
            html += '</div><div class="connector"></div>';
            html += '<div class="org-row">';

            squads.forEach((s, idx) => {
                const slotId = SLOT_BY_SQUAD[idx];
                const sl = slotId && (slotliste[String(slotId)] || slotliste[slotId]);
                const slName = sl && sl.name ? sl.name : '';
                html += '<div class="squad-group">';
                html += '<div class="org-node squad">';
                html += '<input type="text" class="squad-title" value="' + esc(s.title) + '" placeholder="Squad" maxlength="50">';
                html += '<input type="text" class="squad-subtitle slot-input" value="' + esc(s.subtitle) + '" placeholder="SL + Medic" maxlength="40">';
                if (slotId) html += '<input type="text" class="slot-input slot-name" data-slot="' + slotId + '" data-field="name" value="' + esc(slName) + '" placeholder="Name (SL)" maxlength="40">';
                html += '<button class="btn btn-outline btn-rm" onclick="removeSquad(' + idx + ')">Squad entfernen</button>';
                html += '</div>';
                html += '<div class="connector"></div>';
                html += '<div class="ft-row">';
                html += '<div class="org-node fireteam"><input type="text" class="ft-alpha-title" value="' + esc((s.ftAlpha || {}).title) + '" placeholder="FT ALPHA" maxlength="30"><input type="text" class="ft-alpha-sub slot-input" value="' + esc((s.ftAlpha || {}).subtitle) + '" placeholder="FTL-A + 3" maxlength="30"></div>';
                html += '<div class="org-node fireteam"><input type="text" class="ft-bravo-title" value="' + esc((s.ftBravo || {}).title) + '" placeholder="FT BRAVO" maxlength="30"><input type="text" class="ft-bravo-sub slot-input" value="' + esc((s.ftBravo || {}).subtitle) + '" placeholder="FTL-B + 3" maxlength="30"></div>';
                html += '</div></div>';
            });

            html += '</div>';
            chart.innerHTML = html;

            chart.querySelectorAll('input').forEach(inp => {
                const onSave = inp.classList.contains('slot-name') ? saveSlotNames : saveOrg;
                const timerKey = inp.classList.contains('slot-name') ? '_orgSlot' : '_org';
                inp.addEventListener('change', onSave);
                inp.addEventListener('input', () => { clearTimeout(window[timerKey]); window[timerKey] = setTimeout(onSave, 400); });
            });
        }

        function addSquad() {
            try {
                const def = typeof DEFAULT_ORGANIGRAMM !== 'undefined' ? DEFAULT_ORGANIGRAMM : {
                    platoon: { title: 'PLATOON LEAD (PL)', subtitle: 'Zugführer' },
                    squads: [
                        { title: 'SQUAD 1 (ALPHA)', subtitle: 'SL + Medic', ftAlpha: { title: 'FT ALPHA', subtitle: 'FTL-A + 3' }, ftBravo: { title: 'FT BRAVO', subtitle: 'FTL-B + 3' } },
                        { title: 'SQUAD 2 (BRAVO)', subtitle: 'SL + Medic', ftAlpha: { title: 'FT ALPHA', subtitle: 'FTL-A + 3' }, ftBravo: { title: 'FT BRAVO', subtitle: 'FTL-B + 3' } },
                        { title: 'SQUAD 3 (CHARLIE)', subtitle: 'SL + Medic', ftAlpha: { title: 'FT ALPHA', subtitle: 'FTL-A + 3' }, ftBravo: { title: 'FT BRAVO', subtitle: 'FTL-B + 3' } },
                        { title: 'SQUAD 4 (DELTA)', subtitle: 'SL + Medic', ftAlpha: { title: 'FT ALPHA', subtitle: 'FTL-A + 3' }, ftBravo: { title: 'FT BRAVO', subtitle: 'FTL-B + 3' } }
                    ]
                };
                const current = getOrganigrammData();
                const squads = (current.squads || []).map(s => ({
                    title: s.title || '',
                    subtitle: s.subtitle || '',
                    ftAlpha: s.ftAlpha ? { title: s.ftAlpha.title || '', subtitle: s.ftAlpha.subtitle || '' } : { title: 'FT ALPHA', subtitle: 'FTL-A + 3' },
                    ftBravo: s.ftBravo ? { title: s.ftBravo.title || '', subtitle: s.ftBravo.subtitle || '' } : { title: 'FT BRAVO', subtitle: 'FTL-B + 3' }
                }));
                squads.push({
                    title: 'SQUAD ' + (squads.length + 1),
                    subtitle: 'SL + Medic',
                    ftAlpha: { title: 'FT ALPHA', subtitle: 'FTL-A + 3' },
                    ftBravo: { title: 'FT BRAVO', subtitle: 'FTL-B + 3' }
                });
                const newOrg = { platoon: current.platoon || def.platoon, squads };
                updateCsvStorage({ organigramm: newOrg });
                render();
            } catch (e) {
                console.error('addSquad Fehler:', e);
            }
        }

        function removeSquad(idx) {
            const data = getOrganigrammData();
            if (data.squads.length <= 1) return;
            data.squads.splice(idx, 1);
            updateCsvStorage({ organigramm: data });
            render();
        }

        document.getElementById('btn-add-squad').addEventListener('click', addSquad);

        const initData = loadFromCsvStorage();
        if (!initData.organigramm || !initData.organigramm.squads || initData.organigramm.squads.length === 0) {
            const def = typeof DEFAULT_ORGANIGRAMM !== 'undefined' ? DEFAULT_ORGANIGRAMM : {
                platoon: { title: 'PLATOON LEAD (PL)', subtitle: 'Zugführer' },
                squads: [
                    { title: 'SQUAD 1 (ALPHA)', subtitle: 'SL + Medic', ftAlpha: { title: 'FT ALPHA', subtitle: 'FTL-A + 3' }, ftBravo: { title: 'FT BRAVO', subtitle: 'FTL-B + 3' } },
                    { title: 'SQUAD 2 (BRAVO)', subtitle: 'SL + Medic', ftAlpha: { title: 'FT ALPHA', subtitle: 'FTL-A + 3' }, ftBravo: { title: 'FT BRAVO', subtitle: 'FTL-B + 3' } },
                    { title: 'SQUAD 3 (CHARLIE)', subtitle: 'SL + Medic', ftAlpha: { title: 'FT ALPHA', subtitle: 'FTL-A + 3' }, ftBravo: { title: 'FT BRAVO', subtitle: 'FTL-B + 3' } },
                    { title: 'SQUAD 4 (DELTA)', subtitle: 'SL + Medic', ftAlpha: { title: 'FT ALPHA', subtitle: 'FTL-A + 3' }, ftBravo: { title: 'FT BRAVO', subtitle: 'FTL-B + 3' } }
                ]
            };
            updateCsvStorage({ organigramm: def });
        }
        render();
    </script>
</body>
</html>
